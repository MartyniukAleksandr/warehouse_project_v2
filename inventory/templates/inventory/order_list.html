{% extends "inventory/base.html" %}
{% load i18n %}

{% block title %}{% trans "–ê–∫—Ç–∏–≤–Ω—ñ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="mb-0"><i class="bi bi-receipt"></i> {% trans "–ê–∫—Ç–∏–≤–Ω—ñ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è" %}</h2>
    <div class="d-flex align-items-center gap-2">
        {# –ï–∫—Å–ø–æ—Ä—Ç PDF - –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ #}
        <a href="{% url 'inventory:export_orders_pdf' %}?q={{ request.GET.q|default:'' }}&delivery_date_filter={{ request.GET.delivery_date_filter|default:'' }}" class="btn btn-info"><i class="bi bi-file-earmark-pdf"></i> <span class="d-none d-sm-inline">{% trans "–ï–∫—Å–ø–æ—Ä—Ç –≤ PDF" %}</span></a>
        {% if active_shift %}
            <a href="{% url 'inventory:order_add' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">{% trans "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" %}</span></a>
        {% endif %}
    </div>
</div>

{# --- –§–û–†–ú–ê –§–Ü–õ–¨–¢–†–ê–¶–Ü–á –¢–ê –ü–û–®–£–ö–£ (–ó–ê–õ–ò–®–ê–Ñ–ú–û –ë–ï–ó –ó–ú–Ü–ù) --- #}
<div class="mb-4">
    <form method="get" class="row g-3 align-items-end" role="search">

        {# –ü–æ—à—É–∫ –∑–∞ —Ç–µ–∫—Å—Ç–æ–º #}
        <div class="col-12 col-md-5 col-lg-4">
            <label for="id_q" class="form-label">{% trans "–ü–æ—à—É–∫ (–ó–∞–º–æ–≤–Ω–∏–∫/–¢–æ–≤–∞—Ä)" %}</label>
            <input type="text"
                   name="q"
                   id="id_q"
                   class="form-control"
                   placeholder="{% trans "–ü–æ—à—É–∫..." %}"
                   value="{{ request.GET.q|default:'' }}">
        </div>

        {# –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –î–∞—Ç–æ—é –î–æ—Å—Ç–∞–≤–∫–∏ #}
        <div class="col-12 col-md-4 col-lg-3">
            <label for="id_delivery_date_filter" class="form-label">{% trans "–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" %}</label>
            <input type="date"
                   name="delivery_date_filter"
                   id="id_delivery_date_filter"
                   class="form-control"
                   value="{{ selected_delivery_date|default:'' }}">
        </div>

        {# –ö–Ω–æ–ø–∫–∏ –¥—ñ–π #}
        <div class="col-12 col-md-3 col-lg-5 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> {% trans "–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏" %}
            </button>

            {# –ö–Ω–æ–ø–∫–∞ –°–∫–∏–Ω—É—Ç–∏ (–ø–æ–∫–∞–∑—É—î–º–æ, —è–∫—â–æ —î –±—É–¥—å-—è–∫–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä) #}
            {% if request.GET.q or request.GET.delivery_date_filter %}
                <a href="{% url 'inventory:order_list' %}" class="btn btn-outline-secondary">
                    {% trans "–û—á–∏—Å—Ç–∏—Ç–∏" %}
                </a>
            {% endif %}
        </div>
    </form>
</div>
{# --- –ö–Ü–ù–ï–¶–¨ –§–û–†–ú–ò –§–Ü–õ–¨–¢–†–ê–¶–Ü–á –¢–ê –ü–û–®–£–ö–£ --- #}


{% if not orders %}
    {# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ `orders` –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω—å #}
    <div class="alert alert-info">{% trans "–ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ." %}</div>
{% else %}

    {# –Ü—Ç–µ—Ä—É—î–º–æ—Å—è –ø–æ –∑–≥—Ä—É–ø–æ–≤–∞–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö #}
    {% for delivery_date, daily_orders in grouped_orders %}

        {# --- –í–Ü–ó–£–ê–õ–¨–ù–û –í–ò–î–Ü–õ–ï–ù–ê –ì–†–£–ü–ê (–ó–ê–ì–û–õ–û–í–û–ö) --- #}
        <h3 class="mt-4 mb-3 border-bottom pb-2">
            <i class="bi bi-calendar-check-fill text-primary"></i>
            {% trans "–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" %}:
            <strong>{{ delivery_date|date:"d.m.Y"|default:"–ë–µ–∑ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏" }}</strong>
            {% if delivery_date and delivery_date == today %}
                <span class="badge bg-danger ms-2">{% trans "–°—å–æ–≥–æ–¥–Ω—ñ" %}</span>
            {% endif %}
        </h3>

        {# --- –ö–ê–†–¢–ö–ê –î–õ–Ø –¢–ê–ë–õ–ò–¶–Ü (–í–Ü–ó–£–ê–õ–¨–ù–ò–ô –ë–õ–û–ö) --- #}
        <div class="card mb-4 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;">{% trans "‚Ññ" %}</th>
                                <th style="width: 15%;">{% trans "–ó–∞–º–æ–≤–Ω–∏–∫" %}</th>
                                <th>{% trans "–ü–æ–∑–∏—Ü—ñ—ó" %}</th>
                                <th style="width: 10%;">{% trans "–ê–≤—Ç–æ–º–æ–±—ñ–ª—å" %}</th>
                                <th style="width: 10%;">{% trans "–í–æ–¥—ñ–π" %}</th> {# <--- –î–û–î–ê–ù–û: –ö–æ–ª–æ–Ω–∫–∞ "–í–æ–¥—ñ–π" #}
                                <th style="width: 15%;">{% trans "–ü—Ä–∏–º—ñ—Ç–∫–∏" %}</th>
                                <th style="width: 10%;">{% trans "–°—Ç–∞—Ç—É—Å" %}</th>
                                <th style="width: 100px;">{% trans "–î—ñ—ó" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# –Ü—Ç–µ—Ä—É—î–º–æ—Å—è –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Ç–æ—á–Ω–æ—ó –≥—Ä—É–ø–∏ #}
                            {% for order in daily_orders %}
                            <tr>
                                {# –ù—É–º–µ—Ä–∞—Ü—ñ—è –∑ –≤–∞—à–æ—ó –ª–æ–≥—ñ–∫–∏ –≤ get_context_data #}
                                <td>{{ page_obj.start_index|add:order.forloop_counter0 }}</td>
                                <td class="fw-bold">{{ order.customer }}</td>
                                <td>
                                    {# –ó–º–µ–Ω—à–µ–Ω–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Å–ø–∏—Å–∫—É –ø–æ–∑–∏—Ü—ñ–π #}
                                    <ul class="list-unstyled mb-0 small">
                                        {% for item in order.items.all %}
                                        <li>{{ item.product.name }} - **{{ item.ordered_units }}** {% trans "—à—Ç." %}</li>
                                        {% empty %}
                                        <li class="text-muted">{% trans "–ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ–π" %}</li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                {# –ê–≤—Ç–æ–º–æ–±—ñ–ª—å #}
                                <td>
                                    {% if order.car %}
                                        <span class="fw-bold">{{ order.car }}</span>
                                        {% else %}
                                        <span class="text-muted">‚Äì</span>
                                    {% endif %}
                                </td>
                                {# <--- –î–û–î–ê–ù–û: –î–∞–Ω—ñ –í–æ–¥—ñ—è #}
                                <td>
                                    {% if order.driver %}
                                        {{ order.driver }}
                                    {% else %}
                                        <span class="text-muted">‚Äì</span>
                                    {% endif %}
                                </td>
                                {# –ö–Ü–ù–ï–¶–¨ –î–û–î–ê–ù–û–ì–û –ë–õ–û–ö–£ #}
                                <td><span class="small text-muted">{{ order.notes|linebreaksbr|default:"-" }}</span></td>
                               <td>
                                    {# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–ª–∞—Å–∏ –¥–ª—è –∑–Ω–∞—á–∫—ñ–≤ Bootstrap #}
                                    {% if order.status == 'SHIPPED' %}<span class="badge bg-success">{{ order.get_status_display }}</span>
                                    {% elif order.status == 'PENDING' %}<span class="badge bg-warning text-dark">{{ order.get_status_display }}</span>
                                    {% elif order.status == 'LOADED' %}<span class="badge bg-info">{{ order.get_status_display }}</span>
                                    {% elif order.status == 'CANCELLED' %}<span class="badge bg-danger">{{ order.get_status_display }}</span>
                                    {% else %}<span class="badge bg-secondary">{{ order.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if active_shift %}
                                    <div class="d-flex gap-1 flex-nowrap">
                                        {% if order.status == 'PENDING' %}
                                            <form action="{% url 'inventory:order_load' order.pk %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-sm btn-info" title='{% trans "–ì–æ—Ç–æ–≤–µ/–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ" %}'><i class="bi bi-box-arrow-up"></i></button></form>
                                            <a href="{% url 'inventory:order_edit' order.pk %}" class="btn btn-sm btn-outline-secondary" title='{% trans "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" %}'><i class="bi bi-pencil-fill"></i></a>
                                            <form action="{% url 'inventory:order_cancel' order.pk %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-sm btn-warning" title='{% trans "–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" %}' onclick="return confirm('{% trans "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è? –¢–æ–≤–∞—Ä –±—É–¥–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥." %}')"><i class="bi bi-x-circle"></i></button></form>
                                        {% elif order.status == 'LOADED' %}
                                            <button type="button"
                                                    class="btn btn-sm btn-success"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#driverModal"
                                                    data-order-id="{{ order.pk }}"
                                                    data-order-customer="{{ order.customer }}"
                                                    data-driver-id="{{ order.driver.pk|default_if_none:'' }}"
                                                    data-car-id="{{ order.car.pk|default_if_none:'' }}"
                                                    data-action-url="{% url 'inventory:order_ship' pk=order.pk %}"
                                                    title='{% trans "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" %}'>
                                                <i class="bi bi-truck"></i>
                                            </button>
                                            <form action="{% url 'inventory:order_reject_load' order.pk %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-sm btn-danger" title='{% trans "–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è" %}'><i class="bi bi-arrow-counterclockwise"></i></button></form>
                                        {% elif order.status == 'CANCELLED' %}
                                            <form action="{% url 'inventory:delete_cancelled_order' order.pk %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-sm btn-danger" title='{% trans "–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞–∑–∞–≤–∂–¥–∏" %}' onclick="return confirm('{% trans "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ —Å–∫–∞—Å–æ–≤–∞–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ –±—É–¥–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏." %}')"><i class="bi bi-trash-fill"></i></button></form>
                                        {% else %}
                                            <a href="{% url 'inventory:order_edit' order.pk %}" class="btn btn-sm btn-outline-secondary" title='{% trans "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏" %}'><i class="bi bi-eye-fill"></i></a>
                                            <form action="{% url 'inventory:soft_delete_order' order.pk %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-sm btn-secondary" title='{% trans "–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –¥–æ –∞—Ä—Ö—ñ–≤—É" %}' onclick="return confirm('{% trans "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?" %}')"><i class="bi bi-archive-fill"></i></button></form>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% empty %}
        {# –¶–µ–π –±–ª–æ–∫ –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–æ, —è–∫—â–æ `grouped_orders` –ø–æ—Ä–æ–∂–Ω—ñ–π #}
        <div class="alert alert-info">{% trans "–ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ." %}</div>
    {% endfor %}

{% endif %}

{# –ë–õ–û–ö –ü–ê–ì–Ü–ù–ê–¶–Ü–á –ó–ê–õ–ò–®–ê–Ñ–¢–¨–°–Ø –ë–ï–ó –ó–ú–Ü–ù #}
{% if is_paginated %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {# –î–æ–¥–∞—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –¥–æ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó #}
        {% with q=request.GET.q|default:'' delivery_date=request.GET.delivery_date_filter|default:'' %}
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&q={{ q }}&delivery_date_filter={{ delivery_date }}">&laquo;&laquo;</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&delivery_date_filter={{ delivery_date }}">&laquo;</a></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">{% trans "–°—Ç–æ—Ä—ñ–Ω–∫–∞" %} {{ page_obj.number }} {% trans "–∑" %} {{ page_obj.paginator.num_pages }}.</span></li>
            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&delivery_date_filter={{ delivery_date }}">&raquo;</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ q }}&delivery_date_filter={{ delivery_date }}">&raquo;&raquo;</a></li>
            {% endif %}
        {% endwith %}
    </ul>
</nav>
{% endif %}

{# –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –Ü JS-–ö–û–î –ó–ê–õ–ò–®–ê–Æ–¢–¨–°–Ø –ë–ï–ó –ó–ú–Ü–ù #}
<div class="modal fade" id="driverModal" tabindex="-1" aria-labelledby="driverModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="driverModalLabel">{% trans "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–æ–¥—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="driverForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
            <p>{% trans "–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è" %} ‚Ññ: <strong id="modalOrderId"></strong></p>
            <p>{% trans "–ó–∞–º–æ–≤–Ω–∏–∫" %}: <strong id="modalCustomerName"></strong></p>
            <div class="mb-3">
               <label for="{{ driver_form.driver.id_for_label }}" class="form-label">{{ driver_form.driver.label }}*</label>
                {{ driver_form.driver }}
            </div>
            <div class="mb-3">
                <label for="{{ driver_form.car.id_for_label }}" class="form-label">{{ driver_form.car.label }}</label>
                {{ driver_form.car }}
            </div>
            <div class="mb-3">
                <label for="{{ driver_form.nickname.id_for_label }}" class="form-label">{{ driver_form.nickname.label }}</label>
                {{ driver_form.nickname }}
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "–ó–∞–∫—Ä–∏—Ç–∏" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var driverModal = document.getElementById('driverModal');
    if(driverModal) {
        driverModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var orderId = button.getAttribute('data-order-id');
            var customerName = button.getAttribute('data-order-customer');

            // üëá –ù–û–í–ò–ô –ö–û–î: –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ—Ä–µ–∫—Ç–Ω–∏–π URL –∑ –∞—Ç—Ä–∏–±—É—Ç–∞ –∫–Ω–æ–ø–∫–∏
            var actionUrl = button.getAttribute('data-action-url');

            // 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö ID –≤–æ–¥—ñ—è —Ç–∞ –∞–≤—Ç–æ–º–æ–±—ñ–ª—è
            var savedDriverId = button.getAttribute('data-driver-id');
            var savedCarId = button.getAttribute('data-car-id');

            var modalOrderId = driverModal.querySelector('#modalOrderId');
            var modalCustomerName = driverModal.querySelector('#modalCustomerName');
            var driverForm = driverModal.querySelector('#driverForm');

            // 2. –ó–Ω–∞—Ö–æ–¥–∏–º–æ <select> –µ–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º–∏
            var driverSelect = driverForm.querySelector('#{{ driver_form.driver.id_for_label }}');
            var carSelect = driverForm.querySelector('#{{ driver_form.car.id_for_label }}');

            // –û–Ω–æ–≤–ª—é—î–º–æ –≤–º—ñ—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
            if (modalOrderId) {
                modalOrderId.textContent = orderId;
            }
            if (modalCustomerName) {
                modalCustomerName.textContent = customerName;
            }

            // –û–Ω–æ–≤–ª–µ–Ω–∏–π URL –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
            if (actionUrl) {
                driverForm.setAttribute('action', actionUrl);
            }

            // –û–±–æ–≤'—è–∑–∫–æ–≤–æ —Å–∫–∏–¥–∞—î–º–æ —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è–º
            driverForm.reset();

            // 3. –ü–Ü–î–°–¢–ê–ù–û–í–ö–ê –ó–ë–ï–†–ï–ñ–ï–ù–ò–• –ó–ù–ê–ß–ï–ù–¨

            // –í–æ–¥—ñ–π
            if (driverSelect && savedDriverId) {
                 driverSelect.value = savedDriverId;
            }

            // –ê–≤—Ç–æ–º–æ–±—ñ–ª—å
            if (carSelect && savedCarId) {
                carSelect.value = savedCarId;
            }

            // –ü–æ–ª–µ nickname –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø–æ—Ä–æ–∂–Ω—ñ–º
        });
    }
});
</script>
{% endblock %}