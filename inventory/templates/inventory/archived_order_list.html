{% extends "inventory/base.html" %}
{% load i18n %}
{% load static %}
{% load l10n %}

{% block title %}{% trans "–ê—Ä—Ö—ñ–≤ –ó–∞–º–æ–≤–ª–µ–Ω—å" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-archive"></i> {% trans "–ê—Ä—Ö—ñ–≤ –ó–∞–º–æ–≤–ª–µ–Ω—å" %}</h2>
</div>

{# --- –§–û–†–ú–ê –§–Ü–õ–¨–¢–†–ê–¶–Ü–á –¢–ê –ü–û–®–£–ö–£ --- #}
<div class="mb-4">
    <form method="get" class="row g-3 align-items-end" role="search">
        {# –ü–æ—à—É–∫ –∑–∞ —Ç–µ–∫—Å—Ç–æ–º #}
        <div class="col-12 col-md-5 col-lg-4">
            <label for="id_q" class="form-label">{% trans "–ü–æ—à—É–∫ (–ó–∞–º–æ–≤–Ω–∏–∫/–¢–æ–≤–∞—Ä)" %}</label>
            <input type="text"
                   name="q"
                   id="id_q"
                   class="form-control"
                   placeholder="{% trans "–ü–æ—à—É–∫..."%}"
                   value="{{ request.GET.q|default:'' }}">
        </div>

        {# –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –î–∞—Ç–æ—é –î–æ—Å—Ç–∞–≤–∫–∏ #}
        <div class="col-12 col-md-4 col-lg-3">
            <label for="id_delivery_date_filter" class="form-label">{% trans "–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" %}</label>
            <input type="date"
                   name="delivery_date_filter"
                   id="id_delivery_date_filter"
                   class="form-control"
                   value="{{ request.GET.delivery_date_filter|default:'' }}">
        </div>

        {# –ö–Ω–æ–ø–∫–∏ –¥—ñ–π #}
        <div class="col-12 col-md-3 col-lg-5 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> {% trans "–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏" %}
            </button>

            {# –ö–Ω–æ–ø–∫–∞ –°–∫–∏–Ω—É—Ç–∏ #}
            {% if request.GET.q or request.GET.delivery_date_filter %}
                <a href="{% url 'inventory:order_archive' %}" class="btn btn-outline-secondary">
                    {% trans "–û—á–∏—Å—Ç–∏—Ç–∏" %}
                </a>
            {% endif %}
        </div>
    </form>
</div>
{# --- –ö–Ü–ù–ï–¶–¨ –§–û–†–ú–ò –§–Ü–õ–¨–¢–†–ê–¶–Ü–á –¢–ê –ü–û–®–£–ö–£ --- #}


{% if not orders %}
    <div class="alert alert-info">{% trans "–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π." %}</div>
{% else %}

    {# –Ü—Ç–µ—Ä—É—î–º–æ—Å—è –ø–æ –∑–≥—Ä—É–ø–æ–≤–∞–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö #}
    {% for month_key, daily_orders in grouped_orders.items %}

  {# --- –ó–ê–ì–û–õ–û–í–û–ö –ì–†–£–ü–ò (–ù–û–í–ò–ô –ú–Ü–°–Ø–¶–¨) --- #}
        <h3 class="mt-4 mb-3 border-bottom pb-2">
            <i class="bi bi-calendar-check-fill text-secondary"></i>
            {% if month_key == "No-Date" %}
                <strong>{% trans "–ë–µ–∑ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏" %}</strong>
            {% else %}
                {% trans "–ú—ñ—Å—è—Ü—å" %}
                <strong>{{ month_key|date:"F Y" }}</strong>
            {% endif %}
        </h3>

        {# --- –ö–ê–†–¢–ö–ê –ó –¢–ê–ë–õ–ò–¶–ï–Æ –î–õ–Ø –ü–û–¢–û–ß–ù–û–á –ì–†–£–ü–ò --- #}
        <div class="card mb-4 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;">{% trans "‚Ññ" %}</th>
                                <th style="width: 15%;">{% trans "–ó–∞–º–æ–≤–Ω–∏–∫" %}</th>
                                <th>{% trans "–ü–æ–∑–∏—Ü—ñ—ó" %}</th>
                                <th style="width: 10%;">{% trans "–ê–≤—Ç–æ–º–æ–±—ñ–ª—å" %}</th>
                                <th style="width: 10%;">{% trans "–í–æ–¥—ñ–π" %}</th>
                                <th style="width: 10%;">{% trans "–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" %}</th>
                                <th style="width: 10%;">{% trans "–í—Å—å–æ–≥–æ (—à—Ç.)" %}</th>
                                <th style="width: 10%;">{% trans "–°—Ç–∞—Ç—É—Å" %}</th>
                                <th style="width: 15%;">{% trans "–ó–º—ñ–Ω–∞" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# –Ü—Ç–µ—Ä—É—î–º–æ—Å—è –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Ç–æ—á–Ω–æ—ó –≥—Ä—É–ø–∏ #}
                            {% for order in daily_orders %}
                            <tr class="table-secondary">
                                {# üëá –í–ò–ü–†–ê–í–õ–ï–ù–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ page_obj –¥–ª—è –Ω–∞—Å–∫—Ä—ñ–∑–Ω–æ—ó –Ω—É–º–µ—Ä–∞—Ü—ñ—ó #}
                                <td>{{ page_obj.start_index|add:forloop.counter0 }}</td>
                                <td>{{ order.customer }}</td>
                                <td>
                                    <ul class="list-unstyled mb-0 small">
                                        {% for item in order.items.all %}
                                        <li>{{ item.product.name }} - **{{ item.ordered_units }}** {% trans "—à—Ç." %}</li>
                                        {% empty %}
                                        <li>{% trans "–ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ–π" %}</li>
                                        {% endfor %}
                                    </ul>
                                </td>

                                {# –î–∞–Ω—ñ –∞–≤—Ç–æ–º–æ–±—ñ–ª—è #}
                                <td>
                                    {% if order.car %}
                                        <span class="fw-bold">{{ order.car }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äì</span>
                                    {% endif %}
                                </td>

                                {# –î–∞–Ω—ñ –≤–æ–¥—ñ—è #}
                                <td>
                                    {% if order.driver %}
                                        {{ order.driver }}
                                    {% else %}
                                        <span class="text-muted">‚Äì</span>
                                    {% endif %}
                                </td>

                                {# –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–≤–∏–≤–æ–¥–∏—Ç—å—Å—è –ø–æ–≤–Ω–∞ –¥–∞—Ç–∞) #}
                                <td>
                                    {% if order.delivery_date %}
                                        {{ order.delivery_date|date:"d.m.Y" }}
                                    {% else %}
                                        <span class="text-muted">‚Äì</span>
                                    {% endif %}
                                </td>

                                <td><strong>{{ order.total_units }}</strong></td>
                                <td><span class="badge bg-secondary">{{ order.get_status_display }}</span></td>
                                <td>{{ order.work_shift }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% empty %}
        {# –¶–µ–π –±–ª–æ–∫ –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–æ, —è–∫—â–æ 'grouped_orders' –ø–æ—Ä–æ–∂–Ω—ñ–π #}
    {% endfor %}

{% endif %}

{# --- –ë–õ–û–ö –ü–ê–ì–Ü–ù–ê–¶–Ü–á --- #}
{% if is_paginated %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {# –î–æ–¥–∞—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –¥–æ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó #}
        {% with q=request.GET.q|default:'' delivery_date=request.GET.delivery_date_filter|default:'' %}
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&q={{ q }}&delivery_date_filter={{ delivery_date }}">&laquo;&laquo;</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&delivery_date_filter={{ delivery_date }}">&laquo;</a></li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">{% trans "–°—Ç–æ—Ä—ñ–Ω–∫–∞" %} {{ page_obj.number }} {% trans "–∑" %} {{ page_obj.paginator.num_pages }}.</span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&delivery_date_filter={{ delivery_date }}">&raquo;</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ q }}&delivery_date_filter={{ delivery_date }}">&raquo;&raquo;</a></li>
            {% endif %}
        {% endwith %}
    </ul>
</nav>
{% endif %}
{# --- –ö–Ü–ù–ï–¶–¨ –ë–õ–û–ö–£ –ü–ê–ì–Ü–ù–ê–¶–Ü–á --- #}

{% endblock %}